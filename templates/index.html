<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Prompt Engineering – LaTeX Template Generator</title>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --border:#d1d5db;
      --primary:#0f2a44;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --muted:#6b7280;
      --text:#111827;
      --soft:#f8fafc;
      --ok:#16a34a;
      --warn:#b45309;
      --err:#b91c1c;
      --shadow:0 8px 18px rgba(0,0,0,.06);
    }

    *{box-sizing:border-box;font-family:"Segoe UI",Roboto,Arial,sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);}

    header{
      background:var(--primary);
      color:#fff;
      padding:18px 20px;
      border-bottom:4px solid var(--accent);
    }
    .header-row{
      max-width:1200px;margin:auto;
      display:flex;align-items:center;gap:16px;
    }
    .logo{
      height:68px;width:auto;background:#fff;
      padding:6px;border-radius:10px;border:1px solid rgba(0,0,0,.12);
    }
    header h1{margin:0;font-size:1.95rem;letter-spacing:.6px;}
    header h2{margin:6px 0 0;font-weight:400;opacity:.92;font-size:1.02rem;}
    .header-meta{
      margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      font-size:.88rem;opacity:.95;
    }
    .pill{
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08);
      border-radius:999px;
      padding:6px 10px;
      white-space:nowrap;
    }

    main{max-width:1200px;margin:auto;padding:20px 20px 60px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px 18px;
      box-shadow:var(--shadow);
    }
    .title{
      margin:0 0 10px;
      color:var(--primary);
      font-size:1.15rem;
      border-left:4px solid var(--accent);
      padding-left:10px;
    }
    .muted{color:var(--muted);font-size:.92rem;line-height:1.55;margin:0;}

    /* Steps */
    .steps{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;
    }
    .step{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:.88rem;
      color:#111827;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#cbd5e1;
    }
    .step.active{border-color:rgba(37,99,235,.45);background:#eef2ff;}
    .step.active .dot{background:var(--accent);}
    .step.done{border-color:rgba(22,163,74,.35);background:#f0fdf4;}
    .step.done .dot{background:var(--ok);}

    /* Status bar */
    .statusbar{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:var(--soft);
      margin-top:12px;
    }
    .status-label{font-weight:800;color:var(--primary);font-size:.9rem;}
    .status-text{font-size:.9rem;color:#111827;}
    .status-badge{
      margin-left:auto;
      border-radius:999px;padding:6px 10px;
      font-size:.85rem;font-weight:800;
      border:1px solid var(--border);
      background:#fff;
      color:#111827;
      display:flex;align-items:center;gap:8px;
    }
    .badge-ok{border-color:rgba(22,163,74,.35);background:#f0fdf4;}
    .badge-warn{border-color:rgba(180,83,9,.35);background:#fffbeb;}
    .badge-err{border-color:rgba(185,28,28,.35);background:#fef2f2;}
    .spin{
      width:14px;height:14px;border-radius:999px;
      border:2px solid rgba(37,99,235,.25);
      border-top-color: var(--accent);
      animation:rot 0.8s linear infinite;
      display:none;
    }
    .spinning{display:inline-block;}
    @keyframes rot{to{transform:rotate(360deg);} }

    /* Form */
    textarea{
      width:100%;min-height:115px;padding:12px;border-radius:12px;
      border:1px solid var(--border);font-size:.95rem;resize:vertical;background:#fff;
    }
    textarea:focus{outline:none;border-color:rgba(37,99,235,.65);}

    .actions{
      margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    button{
      border:none;border-radius:12px;padding:10px 14px;
      font-weight:900;font-size:.92rem;cursor:pointer;transition:.15s;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent2)}
    .btn-ghost{background:#e5e7eb;color:#111827;}
    .btn-ghost:hover{background:#d1d5db}
    .btn-outline{
      background:#fff;color:#111827;border:1px solid var(--border);
    }
    .btn-outline:hover{background:#f9fafb}
    button:disabled{opacity:.55;cursor:not-allowed}

    /* Tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
    .tab{
      padding:8px 12px;border:1px solid var(--border);
      border-radius:999px;background:#fff;color:#111827;
      font-weight:900;font-size:.9rem;cursor:pointer;
    }
    .tab.active{border-color:rgba(37,99,235,.55);color:var(--accent);background:#eef2ff;}
    .panel{display:none;}
    .panel.active{display:block;}

    /* Previews */
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:980px){ .two{grid-template-columns:1fr;} }
    pre{
      background:var(--soft);
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
      overflow:auto;max-height:420px;
      font-size:.9rem;white-space:pre-wrap;
    }
    .minihead{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0 10px;
    }
    .minihead .label{font-weight:900;color:var(--primary);font-size:.92rem;}
    .minihead .sub{color:var(--muted);font-size:.88rem;}
    .copy-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .hint{
      margin-top:10px;
      border:1px solid var(--border);
      background:#fff;border-radius:12px;
      padding:10px 12px;color:#111827;font-size:.9rem;
    }

    /* History */
    .history{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    .history-item{
      border:1px solid var(--border);
      background:#fff;border-radius:12px;
      padding:10px 12px;
    }
    .history-item .h-title{font-weight:900;color:var(--primary);font-size:.9rem;margin-bottom:6px;}
    .history-item .h-body{color:#111827;font-size:.9rem;white-space:pre-wrap;margin:0;}
    .history-item .h-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;}

    footer{
      text-align:center;margin-top:14px;color:var(--muted);font-size:.85rem;
    }
  </style>
</head>

<body>

<header>
  <div class="header-row">
    <img class="logo" src="{{ url_for('static', filename='ensa_logo.png') }}" alt="ENSA">
    <div>
      <h1>PROMPT ENGINEERING</h1>
      <h2>LaTeX Template Generator – Rapports de stage PFE - GINF-3</h2>
    </div>
    <div class="header-meta">
      <div class="pill">Sans API</div>
      <div class="pill">SCQA · ICDF · Few-shot</div>
      <div class="pill">Flask</div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <section class="card">
      <h3 class="title">Objectif pédagogique</h3>
      <p class="muted">
        Ce site est un démonstrateur académique d’ingénierie de prompting.
        Il permet de corriger une demande libre en un prompt structuré (SCQA + ICDF),
        puis de générer un template LaTeX neutre : pages obligatoires, structure du projet,
        fichiers minimalistes et maintenables, sans contenu technique ni sujet.
      </p>

      <div class="steps" id="steps">
        <div class="step active" id="s1"><span class="dot"></span>Étape 1 : Demande</div>
        <div class="step" id="s2"><span class="dot"></span>Étape 2 : Correction</div>
        <div class="step" id="s3"><span class="dot"></span>Étape 3 : Génération</div>
      </div>

      <div class="statusbar">
        <span class="status-label">Statut</span>
        <span class="status-text" id="statusText">Prêt.</span>
        <span class="status-badge badge-ok" id="statusBadge">
          <span class="spin" id="spinner"></span>
          <span id="statusBadgeText">OK</span>
        </span>
      </div>
    </section>

    <section class="card">
      <h3 class="title">Saisie</h3>
      <p class="muted">
        Entrez une demande libre. Vous pouvez corriger le prompt, puis générer le template neutre.
      </p>

      <textarea id="input" placeholder="Exemple :
Génère un template LaTeX de rapport de stage conforme à une école d’ingénieurs, avec page de garde, remerciements, résumés, table des matières, chapitres, bibliographie et annexes."></textarea>

      <div class="actions">
        <button class="btn-outline" onclick="loadExample()">Charger un exemple</button>
        <button class="btn-ghost" onclick="refinePrompt()">Corriger le prompt</button>
        <button class="btn-primary" onclick="generateTemplate()">Générer le template neutre</button>
        <button class="btn-ghost" id="zipBtn" onclick="downloadZip()" disabled>Télécharger ZIP</button>
      </div>

      <div class="hint">
        Le template généré est neutre : il contient uniquement le format, les pages obligatoires et la structure LaTeX
        (sans sujet, sans contenu technique).
      </div>

      <div class="history" id="history"></div>
    </section>

    <section class="card">
      <div class="tabs">
        <div class="tab active" id="tab-correction" onclick="showTab('correction')">Correction</div>
        <div class="tab" id="tab-frameworks" onclick="showTab('frameworks')">Frameworks</div>
        <div class="tab" id="tab-previews" onclick="showTab('previews')">Previews</div>
        <div class="tab" id="tab-tree" onclick="showTab('tree')">Arborescence</div>
      </div>

      <div class="panel active" id="panel-correction">
        <div class="two">
          <div>
            <div class="minihead">
              <span class="label">Demande brute</span>
              <span class="sub">Texte saisi par l’utilisateur (v1)</span>
            </div>
            <pre id="rawBox">Aucune demande pour le moment.</pre>
            <div class="copy-row">
              <button class="btn-outline" onclick="copyFrom('rawBox')">Copier la demande</button>
            </div>
          </div>

          <div>
            <div class="minihead">
              <span class="label">Prompt corrigé</span>
              <span class="sub">Version structurée (SCQA + ICDF) (v2)</span>
            </div>
            <pre id="refinedBox">Cliquez sur “Corriger le prompt”.</pre>
            <div class="copy-row">
              <button class="btn-outline" onclick="copyFrom('refinedBox')">Copier le prompt corrigé</button>
            </div>
          </div>
        </div>

        <div class="hint" id="qcBox" style="margin-top:12px;">
          Contrôle qualité : en attente de correction.
        </div>
      </div>

      <div class="panel" id="panel-frameworks">
        <pre>SCQA
- Situation : contexte académique (rapports de stage, normes, pages obligatoires)
- Complication : multi-formats, cohérence, maintenance documentaire
- Question : comment produire un template unique, maintenable et réutilisable
- Answer : architecture LaTeX modulaire, métadonnées centralisées, sections balisées

ICDF
- Input : titre, étudiant, établissement, filière, année, encadrants
- Constraints : sobriété, packages standards, séparation contenu/forme, compatibilité Pandoc
- Directives : frontmatter/chapters/backmatter, commentaires pédagogiques, structure reproductible
- Format : arborescence + fichiers .tex + .bib prêts à compiler

Few-shot (méthodologie)
- Exemples utilisés comme références structurelles (pas de copie de contenu)
- Objectif : calibrer les standards académiques attendus</pre>
      </div>

      <div class="panel" id="panel-previews">
        <div class="two">
          <div>
            <div class="minihead">
              <span class="label">Aperçu : main.tex</span>
              <span class="sub">Structure du document maître</span>
            </div>
            <pre id="mainTexBox">Générez un template pour afficher l’aperçu.</pre>
            <div class="copy-row">
              <button class="btn-outline" onclick="copyFrom('mainTexBox')">Copier main.tex</button>
            </div>
          </div>

          <div>
            <div class="minihead">
              <span class="label">Aperçu : metadata.tex</span>
              <span class="sub">Variables à personnaliser</span>
            </div>
            <pre id="metaTexBox">Générez un template pour afficher l’aperçu.</pre>
            <div class="copy-row">
              <button class="btn-outline" onclick="copyFrom('metaTexBox')">Copier metadata.tex</button>
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:12px;">
          Recommandation : utiliser metadata.tex pour centraliser les informations variables (titre, encadrants, année, etc.).
        </div>
      </div>

      <div class="panel" id="panel-tree">
        <div class="minihead">
          <span class="label">Arborescence</span>
          <span class="sub">Liste des fichiers générés</span>
        </div>
        <pre id="treeBox">Générez un template pour afficher l’arborescence.</pre>
        <div class="copy-row">
          <button class="btn-outline" onclick="copyFrom('treeBox')">Copier l’arborescence</button>
        </div>
      </div>
    </section>

    <footer>
      Projet académique – Prompt Engineering · LaTeX · Flask · ABADOUR HICHAM All right reserved 
    </footer>

  </div>
</main>

<script>
  let lastResult = null;
  let historyItems = [];

  function showTab(name){
    const names = ["correction","frameworks","previews","tree"];
    names.forEach(t=>{
      document.getElementById("tab-"+t).classList.toggle("active", t===name);
      document.getElementById("panel-"+t).classList.toggle("active", t===name);
    });
  }

  function setStep(step){
    const s1 = document.getElementById("s1");
    const s2 = document.getElementById("s2");
    const s3 = document.getElementById("s3");
    [s1,s2,s3].forEach(s=>{ s.classList.remove("active"); s.classList.remove("done"); });

    if(step === 1){
      s1.classList.add("active");
    }else if(step === 2){
      s1.classList.add("done");
      s2.classList.add("active");
    }else if(step === 3){
      s1.classList.add("done");
      s2.classList.add("done");
      s3.classList.add("active");
    }
  }

  function setStatus(kind, text, badgeText, spinning){
    const statusText = document.getElementById("statusText");
    const statusBadge = document.getElementById("statusBadge");
    const statusBadgeText = document.getElementById("statusBadgeText");
    const spinner = document.getElementById("spinner");

    statusText.textContent = text;
    statusBadgeText.textContent = badgeText;

    statusBadge.classList.remove("badge-ok","badge-warn","badge-err");
    if(kind === "ok") statusBadge.classList.add("badge-ok");
    if(kind === "warn") statusBadge.classList.add("badge-warn");
    if(kind === "err") statusBadge.classList.add("badge-err");

    spinner.classList.toggle("spinning", !!spinning);
  }

  function loadExample(){
    document.getElementById("input").value =
      "Génère un template LaTeX de rapport de stage d’école d’ingénieurs, " +
      "avec page de garde, remerciements, résumés FR/EN, table des matières, " +
      "chapitres, bibliographie et annexes. Le contenu doit être neutre et maintenable.";
  }

  async function copyFrom(id){
    const text = document.getElementById(id).textContent;
    try{
      await navigator.clipboard.writeText(text);
      setStatus("ok", "Copie effectuée dans le presse-papier.", "OK", false);
    }catch(e){
      setStatus("warn", "Copie impossible (navigateur). Sélectionnez et copiez manuellement.", "INFO", false);
    }
  }

  function updateQC(refined){
    const qc = document.getElementById("qcBox");
    const checks = [
      {name:"SCQA", ok: refined.includes("SCQA")},
      {name:"ICDF", ok: refined.includes("ICDF")},
      {name:"Contraintes", ok: refined.toLowerCase().includes("contraintes")},
      {name:"Directives", ok: refined.toLowerCase().includes("directives")},
      {name:"Sortie neutre", ok: refined.toLowerCase().includes("sans contenu") || refined.toLowerCase().includes("neutre")}
    ];
    const okCount = checks.filter(c=>c.ok).length;
    qc.textContent = "Contrôle qualité : " + checks.map(c => (c.ok ? "OK " : "Manque ") + c.name).join(" · ");
    if(okCount >= 4) setStatus("ok", "Prompt corrigé et conforme aux frameworks.", "OK", false);
    else setStatus("warn", "Prompt corrigé, mais certains éléments peuvent être renforcés.", "INFO", false);
  }

  function pushHistory(raw, refined){
    historyItems.unshift({raw, refined, ts: new Date()});
    historyItems = historyItems.slice(0,3);

    const box = document.getElementById("history");
    box.innerHTML = "";

    historyItems.forEach((it, idx)=>{
      const div = document.createElement("div");
      div.className = "history-item";
      const title = document.createElement("div");
      title.className = "h-title";
      title.textContent = "Historique #" + (idx+1) + " – " + it.ts.toLocaleString();

      const body = document.createElement("p");
      body.className = "h-body";
      body.textContent = it.raw;

      const actions = document.createElement("div");
      actions.className = "h-actions";

      const b1 = document.createElement("button");
      b1.className = "btn-outline";
      b1.textContent = "Recharger";
      b1.onclick = () => { document.getElementById("input").value = it.raw; };

      const b2 = document.createElement("button");
      b2.className = "btn-outline";
      b2.textContent = "Voir prompt corrigé";
      b2.onclick = () => {
        document.getElementById("rawBox").textContent = it.raw;
        document.getElementById("refinedBox").textContent = it.refined;
        updateQC(it.refined);
        showTab("correction");
        setStep(2);
      };

      actions.appendChild(b1);
      actions.appendChild(b2);

      div.appendChild(title);
      div.appendChild(body);
      div.appendChild(actions);
      box.appendChild(div);
    });
  }

  async function refinePrompt(){
    const msg = document.getElementById("input").value.trim();
    if(!msg) return;

    setStep(2);
    setStatus("warn", "Correction du prompt en cours...", "EN COURS", true);

    document.getElementById("rawBox").textContent = msg;
    document.getElementById("refinedBox").textContent = "Correction en cours...";
    showTab("correction");

    const res = await fetch("/api/refine", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({message: msg})
    });

    const json = await res.json();
    if(!json.ok){
      document.getElementById("refinedBox").textContent = "Erreur lors de la correction.";
      setStatus("err", "Erreur lors de la correction du prompt.", "ERREUR", false);
      return;
    }

    document.getElementById("refinedBox").textContent = json.refined_prompt;
    updateQC(json.refined_prompt);
    pushHistory(msg, json.refined_prompt);
  }

  function fileContent(result, path){
    const f = (result?.files || []).find(x => x.path === path);
    return f ? f.content : "";
  }

  async function generateTemplate(){
    const msg = document.getElementById("input").value.trim();
    if(!msg) return;

    setStep(3);
    setStatus("warn", "Génération du template en cours...", "EN COURS", true);
    document.getElementById("zipBtn").disabled = true;

    document.getElementById("treeBox").textContent = "Génération en cours...";
    document.getElementById("mainTexBox").textContent = "Génération en cours...";
    document.getElementById("metaTexBox").textContent = "Génération en cours...";
    showTab("tree");

    const res = await fetch("/api/chat", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({message: msg})
    });

    const json = await res.json();
    if(!json.ok){
      setStatus("err", "Erreur lors de la génération du template.", "ERREUR", false);
      return;
    }

    const data = json.data;
    lastResult = data.result;

    // correction panel update
    document.getElementById("rawBox").textContent = msg;
    document.getElementById("refinedBox").textContent = data.prompt_used;
    updateQC(data.prompt_used);
    pushHistory(msg, data.prompt_used);

    // tree
    const tree = data.result.files.map(f => "- " + f.path).join("\n");
    document.getElementById("treeBox").textContent = tree;

    // previews
    const mainTex = fileContent(data.result, "main.tex") || "main.tex introuvable dans le résultat.";
    const metaTex = fileContent(data.result, "config/metadata.tex") || "metadata.tex introuvable dans le résultat.";
    document.getElementById("mainTexBox").textContent = mainTex;
    document.getElementById("metaTexBox").textContent = metaTex;

    document.getElementById("zipBtn").disabled = false;
    setStatus("ok", "Template généré. Téléchargement ZIP disponible.", "OK", false);
  }

  async function downloadZip(){
    if(!lastResult) return;

    setStatus("warn", "Préparation du téléchargement...", "EN COURS", true);

    const res = await fetch("/api/zip", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({result: lastResult})
    });

    const blob = await res.blob();
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "template_latex_rapport_stage.zip";
    a.click();
    URL.revokeObjectURL(a.href);

    setStatus("ok", "Téléchargement lancé.", "OK", false);
  }

  // init
  setStep(1);
  setStatus("ok", "Prêt.", "OK", false);
</script>

</body>
</html>
